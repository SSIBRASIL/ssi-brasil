<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OM RP Engenharia</title>

<style>
body{font-family:Arial;background:#eef2f6;margin:0;padding:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:12px}

.topo-img{
  width:100%;
  max-height:120px;
  object-fit:contain;
  display:block;
  margin-bottom:10px;
}

h2{background:#0b3d91;color:#fff;padding:8px;border-radius:6px;font-size:16px}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
@media(max-width:768px){
  .grid{grid-template-columns:1fr;}
}

.campo{
  display:flex;
  flex-direction:column;
  font-size:13px;
  font-weight:bold;
}
.campo span{margin-bottom:2px;color:#0b3d91;}

input,select,textarea{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #aaa;
  font-weight:normal;
}
textarea{min-height:60px}

button{
  width:100%;
  margin-top:10px;
  background:#0b3d91;
  color:#fff;
  border:none;
  padding:12px;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

canvas{
  border:1px solid #333;
  border-radius:8px;
  width:100%;
  height:180px;
  background:#fff;
  touch-action:none;
}

.photo-preview img{
  height:70px;
  margin:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

.nota{
  font-size:12px;
  color:#444;
  margin-top:8px;
}
</style>
</head>

<body>
<div class="container">

<img src="RP.jpg" class="topo-img" alt="RP Engenharia">

<h2>Dados Gerais</h2>
<div class="grid">
  <div class="campo"><span>Instala√ß√£o *</span><input id="instalacao"></div>
  <div class="campo"><span>Munic√≠pio *</span><input id="municipio"></div>
  <div class="campo"><span>OS SAP *</span><input id="os"></div>
  <div class="campo"><span>Data</span><input type="date" id="data"></div>
  <div class="campo"><span>Hora</span><input type="time" id="hora"></div>
</div>

<h2>Atividade necessita de:</h2>
<div class="grid">
  <div class="campo"><span>APR</span><select id="apr"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>LPE</span><select id="lpe"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>PET</span><select id="pet"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
</div>

<h2>Equipe</h2>
<div class="grid">
  <div class="campo"><span>Nome 1</span><input id="nome1"></div>
  <div class="campo"><span>Nome 2</span><input id="nome2"></div>
  <div class="campo"><span>Nome 3</span><input id="nome3"></div>
  <div class="campo"><span>Nome 4</span><input id="nome4"></div>
</div>

<h2>Esta√ß√£o / Grupo</h2>
<div class="campo">
  <span>Esta√ß√£o/Grupo permaneceu desligado ou indispon√≠vel durante a manuten√ß√£o?</span>
  <select id="grupo_status">
    <option value="">Selecione</option>
    <option>N√£o</option>
    <option>Sim</option>
  </select>
</div>

<div id="grupo_select_box" style="display:none;">
  <div class="campo">
    <span>Selecionar Grupo</span>
    <select id="grupo_num">
      <option value="">Selecione</option>
      <option>Grupo 1</option>
      <option>Grupo 2</option>
      <option>Grupo 3</option>
      <option>Grupo 4</option>
    </select>
  </div>
</div>

<div id="tempo_grupo_box" class="grid" style="display:none;">
  <div class="campo"><span>Hora In√≠cio</span><input type="time" id="g_inicio"></div>
  <div class="campo"><span>Hora Fim</span><input type="time" id="g_fim"></div>
  <div class="campo"><span>Total (h)</span><input id="g_total" readonly></div>
</div>

<h2>Servi√ßos</h2>
<div class="campo"><span>Situa√ß√£o encontrada *</span><textarea id="resumo"></textarea></div>
<div class="campo"><span>Ocorr√™ncia</span><textarea id="ocorrencia"></textarea></div>
<div class="campo"><span>Servi√ßo realizado</span><textarea id="realizado"></textarea></div>

<h2>Fotos (obrigat√≥rio)</h2>
<input type="file" id="fotos" multiple accept="image/*">
<div class="photo-preview" id="preview"></div>

<h2>Respons√°vel</h2>
<div class="campo"><span>Nome do respons√°vel *</span><input id="responsavel"></div>

<h2>Assinatura</h2>
<canvas id="sign"></canvas>
<button type="button" onclick="limparAssinatura()">Limpar assinatura</button>

<button type="button" onclick="gerarPDF()">üíæ SALVAR PDF</button>
<button type="button" onclick="enviarWhats()">üì≤ ENVIAR WHATSAPP</button>

<div class="nota">
  * No celular, o envio tenta anexar o PDF automaticamente via compartilhamento. No PC, o WhatsApp abre com a mensagem pronta e o anexo √© manual (limita√ß√£o do WhatsApp Web).
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
// ========= CONFIG =========
const WHATS_PHONE = "5511981374513"; // troque aqui

// ========= NOME DO ARQUIVO (DATA+HORA) =========
function dataHoraArquivo(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}_${hh}${mi}`;
}
function limparTextoArquivo(s){
  return (s || "")
    .toString()
    .trim()
    .replace(/[^\w\-]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "");
}

// ========= GRUPO (altera√ß√£o correta) =========
function limparGrupoETempo(){
  grupo_num.value = "";
  g_inicio.value = "";
  g_fim.value = "";
  g_total.value = "";
  tempo_grupo_box.style.display = "none";
}

grupo_status.addEventListener("change", () => {
  const sim = grupo_status.value === "Sim";
  grupo_select_box.style.display = sim ? "block" : "none";
  limparGrupoETempo(); // sempre reseta ao trocar status
});

grupo_num.addEventListener("change", () => {
  const liberar = (grupo_status.value === "Sim" && !!grupo_num.value);
  tempo_grupo_box.style.display = liberar ? "grid" : "none";
  if(!liberar){
    g_inicio.value = "";
    g_fim.value = "";
    g_total.value = "";
  }
});

// ========= C√ÅLCULO TEMPO =========
function calc(i,f){
  if(!i||!f)return"";
  let [hi,mi]=i.split(":").map(Number);
  let [hf,mf]=f.split(":").map(Number);
  let t=(hf*60+mf)-(hi*60+mi);
  if(t<0)t+=1440;
  return (t/60).toFixed(2);
}
g_inicio.onchange=g_fim.onchange=()=>{
  g_total.value=calc(g_inicio.value,g_fim.value);
};

// ========= ASSINATURA (MOUSE + TOUCH) =========
const canvas = document.getElementById("sign");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const r = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * r;
  canvas.height = canvas.offsetHeight * r;
  ctx.setTransform(r,0,0,r,0,0);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let desenhando = false;

function getPos(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
  }
  return [e.clientX - rect.left, e.clientY - rect.top];
}
function startDraw(e){
  e.preventDefault();
  desenhando = true;
  ctx.beginPath();
  const [x,y] = getPos(e);
  ctx.moveTo(x,y);
}
function moveDraw(e){
  if(!desenhando) return;
  e.preventDefault();
  const [x,y] = getPos(e);
  ctx.lineTo(x,y);
  ctx.stroke();
}
function endDraw(){
  desenhando = false;
}

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
canvas.addEventListener("mouseup", endDraw);
canvas.addEventListener("mouseleave", endDraw);

canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw);

function limparAssinatura(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

// ========= FOTOS =========
let imagens = []; // {dataUrl, name}
fotos.onchange = (e) => {
  imagens = [];
  preview.innerHTML = "";
  [...e.target.files].forEach(file=>{
    const r = new FileReader();
    r.onload = (x)=>{
      imagens.push({ dataUrl: x.target.result, name: file.name });
      const im = document.createElement("img");
      im.src = x.target.result;
      preview.appendChild(im);
    };
    r.readAsDataURL(file);
  });
};

// ========= HELPERS =========
function isBlank(v){ return !v || !String(v).trim(); }

async function fetchAsDataURL(url){
  const res = await fetch(url);
  const blob = await res.blob();
  return await new Promise((resolve)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.readAsDataURL(blob);
  });
}

function buildWhatsText(){
  const parts = [];
  parts.push("OM RP ENGENHARIA");
  if(!isBlank(os.value)) parts.push(`OS: ${os.value}`);
  if(!isBlank(instalacao.value)) parts.push(`Instala√ß√£o: ${instalacao.value}`);
  if(!isBlank(municipio.value)) parts.push(`Munic√≠pio: ${municipio.value}`);
  if(!isBlank(data.value)) parts.push(`Data: ${data.value}`);
  if(!isBlank(hora.value)) parts.push(`Hora: ${hora.value}`);

  if(grupo_status.value === "Sim" && grupo_num.value){
    parts.push(`Grupo indispon√≠vel: Sim (${grupo_num.value})`);
    if(g_total.value) parts.push(`Tempo: ${g_total.value} h`);
  } else if(grupo_status.value === "N√£o"){
    parts.push("Grupo indispon√≠vel: N√£o");
  }

  if(!isBlank(resumo.value)) parts.push(`Situa√ß√£o: ${resumo.value}`);
  if(!isBlank(responsavel.value)) parts.push(`Respons√°vel: ${responsavel.value}`);
  return parts.join("\n");
}

// ========= PDF (gera + retorna blob) =========
async function gerarPDFBlob(){
  // valida√ß√£o m√≠nima (ajuste se quiser)
  if(isBlank(instalacao.value) || isBlank(municipio.value) || isBlank(os.value) || isBlank(resumo.value) || isBlank(responsavel.value)){
    alert("Preencha os campos obrigat√≥rios: Instala√ß√£o, Munic√≠pio, OS SAP, Situa√ß√£o encontrada e Respons√°vel.");
    throw new Error("Campos obrigat√≥rios n√£o preenchidos.");
  }
  if(imagens.length === 0){
    alert("Inclua pelo menos 1 foto (obrigat√≥rio).");
    throw new Error("Sem fotos.");
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4", compress: true });

  // logo
  let logo = "";
  try { logo = await fetchAsDataURL("RP.jpg"); } catch(e) {}

  if(logo){
    // tenta como JPEG e se falhar, cai como PNG
    try { doc.addImage(logo, "JPEG", 10, 8, 55, 18); }
    catch(e){ doc.addImage(logo, "PNG", 10, 8, 55, 18); }
  }

  doc.setFontSize(14);
  doc.text("ORDEM DE MANUTEN√á√ÉO - RP ENGENHARIA", 105, 18, { align: "center" });
  doc.setFontSize(9);
  doc.text("Desenvolvido por Lucas Moreira Rodrigues", 105, 24, { align: "center" });

  // tabela dados
  const equipe = [nome1.value, nome2.value, nome3.value, nome4.value].filter(v=>!isBlank(v)).join(" / ");
  const dados = [
    ["Instala√ß√£o", instalacao.value],
    ["Munic√≠pio", municipio.value],
    ["OS SAP", os.value],
    ["Data", data.value || ""],
    ["Hora", hora.value || ""],
    ["APR", apr.value || ""],
    ["LPE", lpe.value || ""],
    ["PET", pet.value || ""],
    ["Equipe", equipe]
  ];

  if(grupo_status.value === "Sim"){
    dados.push(["Grupo indispon√≠vel", "Sim"]);
    dados.push(["Grupo", grupo_num.value || ""]);
    dados.push(["Hora in√≠cio", g_inicio.value || ""]);
    dados.push(["Hora fim", g_fim.value || ""]);
    dados.push(["Total (h)", g_total.value || ""]);
  } else if(grupo_status.value === "N√£o"){
    dados.push(["Grupo indispon√≠vel", "N√£o"]);
  }

  doc.autoTable({
    startY: 30,
    head: [["Campo", "Valor"]],
    body: dados,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [11, 61, 145] },
    theme: "grid"
  });

  let y = doc.lastAutoTable.finalY + 6;

  // servi√ßos
  doc.setFontSize(11);
  doc.text("Servi√ßos", 10, y);
  y += 4;

  const blocos = [
    ["Situa√ß√£o encontrada", resumo.value],
    ["Ocorr√™ncia", ocorrencia.value || ""],
    ["Servi√ßo realizado", realizado.value || ""]
  ];

  doc.setFontSize(9);
  for(const [tit, txt] of blocos){
    doc.setFont(undefined, "bold");
    doc.text(tit + ":", 10, y);
    y += 4;
    doc.setFont(undefined, "normal");

    const lines = doc.splitTextToSize(txt || "", 190);
    doc.text(lines, 10, y);
    y += Math.max(6, lines.length * 4) + 2;

    if(y > 250){
      doc.addPage();
      y = 20;
    }
  }

  // respons√°vel + assinatura
  doc.setFont(undefined, "bold");
  doc.text("Respons√°vel: ", 10, y);
  doc.setFont(undefined, "normal");
  doc.text(responsavel.value, 35, y);
  y += 8;

  doc.setFont(undefined, "bold");
  doc.text("Assinatura:", 10, y);
  doc.setFont(undefined, "normal");
  y += 2;

  const signData = canvas.toDataURL("image/png");
  doc.addImage(signData, "PNG", 10, y, 80, 30);
  y += 38;

  // fotos (p√°gina(s))
  doc.setFont(undefined, "bold");
  doc.text("Fotos", 10, y);
  doc.setFont(undefined, "normal");
  y += 4;

  for(let i=0; i<imagens.length; i++){
    if(y > 240){
      doc.addPage();
      y = 20;
    }

    doc.setFontSize(9);
    doc.text(`Foto ${i+1}`, 10, y);
    y += 2;

    // insere foto (melhor compatibilidade como JPEG)
    const imgData = imagens[i].dataUrl;
    try {
      doc.addImage(imgData, "JPEG", 10, y, 180, 90, undefined, "FAST");
    } catch(e) {
      // se n√£o for JPEG, tenta PNG
      doc.addImage(imgData, "PNG", 10, y, 180, 90);
    }
    y += 98;
  }

  const osSafe = limparTextoArquivo(os.value) || "SEM_OS";
  const filename = `OM_${dataHoraArquivo()}_${osSafe}.pdf`;
  const blob = doc.output("blob");
  return { blob, filename, doc };
}

// ========= SALVAR PDF =========
async function gerarPDF(){
  const { blob, filename } = await gerarPDFBlob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ========= ENVIAR WHATS =========
async function enviarWhats(){
  const texto = buildWhatsText();
  const { blob, filename } = await gerarPDFBlob();
  const file = new File([blob], filename, { type: "application/pdf" });

  // 1) Celular: tenta compartilhar com arquivo (WhatsApp aparece no menu)
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try{
      await navigator.share({
        title: "OM RP Engenharia",
        text: texto,
        files: [file]
      });
      return;
    }catch(e){
      // cancelado ou falhou -> fallback abaixo
    }
  }

  // 2) Fallback (PC / sem share): baixa e abre mensagem no Whats
  await gerarPDF();
  const link = "https://wa.me/" + WHATS_PHONE + "?text=" + encodeURIComponent(texto + "\n\nPDF gerado: " + filename + "\n(Anexe o arquivo baixado aqui.)");
  window.open(link, "_blank");
}
</script>

</body>
</html>
