<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OM RP Engenharia</title>

<style>
  body{font-family:Arial;background:#eef2f6;margin:0;padding:10px}
  .container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:12px}
  .topo-img{width:100%;height:130px;object-fit:cover;display:block;margin-bottom:10px;border-radius:10px}
  h2{background:#0b3d91;color:#fff;padding:8px;border-radius:6px;font-size:16px;margin:14px 0 10px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  @media(max-width:768px){.grid{grid-template-columns:1fr}}
  .campo{display:flex;flex-direction:column;font-size:13px;font-weight:bold}
  .campo span{margin-bottom:2px;color:#0b3d91}
  input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #aaa;font-weight:normal;box-sizing:border-box}
  textarea{min-height:70px}
  button{width:100%;margin-top:10px;background:#0b3d91;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer}
  .btn-sec{background:#1d6fd8}
  .btn-danger{background:#b42318}
  canvas{border:1px solid #333;border-radius:8px;width:100%;height:180px;background:#fff;touch-action:none}
  .photo-preview img{height:70px;margin:4px;border-radius:6px;border:1px solid #ccc}
  .nota{font-size:12px;color:#444;margin-top:8px}
  .group-row{
    display:grid;
    grid-template-columns: 1.2fr 1fr 1fr 1fr 0.8fr;
    gap:8px;
    align-items:end;
    margin-top:8px;
  }
  @media(max-width:768px){.group-row{grid-template-columns:1fr}}
  .group-row .remover{height:38px;margin-top:0}
  .team-row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  @media(max-width:768px){.team-row{grid-template-columns:1fr}}
  .team-extra-row{
    display:grid;
    grid-template-columns: 1fr 0.8fr;
    gap:8px;
    align-items:end;
    margin-top:8px;
  }
  @media(max-width:768px){.team-extra-row{grid-template-columns:1fr}}
  .team-extra-row .remover{height:38px;margin-top:0}
</style>
</head>

<body>
<div class="container">

  <img src="RP.jpg" class="topo-img" alt="RP Engenharia">

  <h2>Dados Gerais</h2>
  <div class="grid">
    <div class="campo"><span>Instala√ß√£o *</span><input id="instalacao"></div>
    <div class="campo"><span>Munic√≠pio *</span><input id="municipio"></div>
    <div class="campo"><span>OS SAP *</span><input id="os"></div>
    <div class="campo"><span>Data</span><input type="date" id="data"></div>

    <!-- Mant√©m s√≥ Hor√°rio inicial (sem campo Hora e sem tempo de atividade aqui) -->
    <div class="campo"><span>Hor√°rio inicial *</span><input type="time" id="hora_inicio"></div>
    <div class="campo"><span></span><div style="height:38px"></div></div>
    <div class="campo"><span></span><div style="height:38px"></div></div>
    <div class="campo"><span></span><div style="height:38px"></div></div>
  </div>

  <h2>Documenta√ß√£o de Seguran√ßa</h2>
  <div class="grid">
    <div class="campo"><span>APR *</span><select id="apr"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
    <div class="campo"><span>LPE *</span><select id="lpe"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
    <div class="campo"><span>PET *</span><select id="pet"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
    <div class="campo"><span></span><div style="height:38px"></div></div>
  </div>

  <h2>Equipe</h2>
  <div class="team-row">
    <div class="campo"><span>Nome 1 *</span><input id="nome1"></div>
    <div class="campo"><span>Nome 2 *</span><input id="nome2"></div>
  </div>
  <div id="team_extras" style="margin-top:8px;"></div>
  <button type="button" class="btn-sec" id="btn_add_team">‚ûï Adicionar membro (opcional)</button>

  <h2>Indisponibilidade Esta√ß√£o/Grupo</h2>
  <div class="campo">
    <span>Esta√ß√£o/Grupo permaneceu desligado ou indispon√≠vel durante a manuten√ß√£o? *</span>
    <select id="grupo_status">
      <option value="">Selecione</option>
      <option>N√£o</option>
      <option>Sim</option>
    </select>
  </div>

  <div id="grupos_box" style="display:none; margin-top:10px;">
    <div class="campo">
      <span>Grupos indispon√≠veis (adicione quantos forem necess√°rios)</span>
      <button type="button" class="btn-sec" id="btn_add_grupo">‚ûï Adicionar Grupo</button>
    </div>
    <div id="lista_grupos"></div>
  </div>

  <!-- INSPE√á√ÉO (antes de el√©trica) -->
  <h2>Inspe√ß√£o</h2>
  <div class="campo">
    <span>Necess√°rio realizar inspe√ß√£o? *</span>
    <select id="insp_status">
      <option value="">Selecione</option>
      <option>N√£o</option>
      <option>Sim</option>
    </select>
  </div>
  <div id="insp_box" style="display:none; margin-top:8px;">
    <div class="campo">
      <span>Descrever inspe√ß√£o *</span>
      <textarea id="insp_dados"></textarea>
    </div>
  </div>

  <h2>Grandezas El√©tricas</h2>
  <div class="campo">
    <span>Necess√°rio medir grandezas el√©tricas? *</span>
    <select id="medir_status">
      <option value="">Selecione</option>
      <option>N√£o</option>
      <option>Sim</option>
    </select>
  </div>
  <div id="medir_box" style="display:none; margin-top:8px;">
    <div class="campo">
      <span>Preencher medi√ß√µes *</span>
      <textarea id="medir_dados"></textarea>
    </div>
  </div>

  <h2>Inspe√ß√£o Hidr√°ulica</h2>
  <div class="campo">
    <span>Necess√°rio realizar inspe√ß√£o hidr√°ulica / medir grandezas? *</span>
    <select id="hid_status">
      <option value="">Selecione</option>
      <option>N√£o</option>
      <option>Sim</option>
    </select>
  </div>
  <div id="hid_box" style="display:none; margin-top:8px;">
    <div class="campo">
      <span>Preencher valores *</span>
      <textarea id="hid_dados"></textarea>
    </div>
  </div>

  <h2>Materiais</h2>
  <div class="campo">
    <span>Houve a utiliza√ß√£o de materiais? *</span>
    <select id="mat_status">
      <option value="">Selecione</option>
      <option>N√£o</option>
      <option>Sim</option>
    </select>
  </div>
  <div id="mat_box" style="display:none; margin-top:8px;">
    <div class="campo">
      <span>Descrever materiais utilizados *</span>
      <textarea id="mat_dados"></textarea>
    </div>
  </div>

  <h2>Servi√ßos</h2>
  <div class="campo"><span>Ocorr√™ncia *</span><textarea id="ocorrencia"></textarea></div>
  <div class="campo"><span>Situa√ß√£o encontrada *</span><textarea id="resumo"></textarea></div>
  <div class="campo"><span>Servi√ßo realizado</span><textarea id="realizado"></textarea></div>

  <h2>Fotos (obrigat√≥rio)</h2>
  <input type="file" id="fotos" multiple accept="image/*">
  <div class="photo-preview" id="preview"></div>

  <h2>Respons√°vel</h2>
  <div class="campo"><span>Nome do respons√°vel *</span><input id="responsavel"></div>

  <!-- Tempo de atividade apenas aqui no final -->
  <h2>Encerramento</h2>
  <div class="grid">
    <div class="campo"><span>Hor√°rio final da atividade *</span><input type="time" id="hora_fim"></div>
    <div class="campo"><span>Tempo de atividade (HH:MM)</span><input id="tempo_atividade" readonly></div>
    <div></div><div></div>
  </div>

  <h2>Assinatura</h2>
  <canvas id="sign"></canvas>
  <button type="button" class="btn-danger" id="limpar">Limpar assinatura</button>

  <button type="button" id="pdf">üíæ SALVAR PDF</button>
  <button type="button" id="excel">üìä SALVAR EXCEL</button>
  <button type="button" id="whats">üì≤ ENVIAR WHATSAPP</button>

  <div class="nota">
    * No celular, o envio tenta anexar o PDF automaticamente via compartilhamento. No PC, o WhatsApp abre com a mensagem pronta e o anexo √© manual.
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const WHATS_PHONE = "5511981374513"; // troque aqui
  const $ = (id) => document.getElementById(id);
  const isBlank = (v) => !v || !String(v).trim();

  function dataHoraArquivo(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${yyyy}${mm}${dd}_${hh}${mi}`;
  }

  function limparTextoArquivo(s){
    return (s || "").toString().trim().replace(/[^\w\-]+/g, "_").replace(/_+/g, "_").replace(/^_+|_+$/g, "");
  }

  function calcDuracaoHHMM(inicio, fim){
    if(!inicio || !fim) return "";
    const [hi, mi] = inicio.split(":").map(Number);
    const [hf, mf] = fim.split(":").map(Number);
    let start = hi*60 + mi, end = hf*60 + mf;
    let diff = end - start;
    if(diff < 0) diff += 1440;
    const h = Math.floor(diff/60), m = diff % 60;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function atualizarTempoAtividade(){
    $("tempo_atividade").value = calcDuracaoHHMM($("hora_inicio").value, $("hora_fim").value);
  }
  $("hora_inicio").addEventListener("change", atualizarTempoAtividade);
  $("hora_fim").addEventListener("change", atualizarTempoAtividade);

  // Equipe
  const teamExtras = $("team_extras");
  const btnAddTeam = $("btn_add_team");
  let teamExtraCount = 0;

  btnAddTeam.addEventListener("click", () => {
    teamExtraCount++;
    const row = document.createElement("div");
    row.className = "team-extra-row";
    row.innerHTML = `
      <div class="campo">
        <span>Nome ${2 + teamExtraCount}</span>
        <input data-role="team-extra" />
      </div>
      <button type="button" class="btn-danger remover" data-role="remover">Remover</button>
    `;
    row.querySelector('[data-role="remover"]').addEventListener("click", () => row.remove());
    teamExtras.appendChild(row);
  });

  function listarEquipe(){
    const extras = [...teamExtras.querySelectorAll('[data-role="team-extra"]')].map(i => i.value).filter(v => !isBlank(v));
    return [$("nome1").value, $("nome2").value, ...extras].filter(v => !isBlank(v));
  }

  // Grupos
  const gruposBox = $("grupos_box");
  const listaGrupos = $("lista_grupos");
  const btnAddGrupo = $("btn_add_grupo");

  function limparGrupos(){ listaGrupos.innerHTML = ""; }

  function criarLinhaGrupo(){
    const row = document.createElement("div");
    row.className = "group-row";
    row.innerHTML = `
      <div class="campo">
        <span>Grupo</span>
        <select data-role="grupo">
          <option value="">Selecione</option>
          <option>Grupo 1</option>
          <option>Grupo 2</option>
          <option>Grupo 3</option>
          <option>Grupo 4</option>
          <option>Instala√ß√£o (toda parada)</option>
        </select>
      </div>
      <div class="campo"><span>Hora In√≠cio</span><input type="time" data-role="inicio" /></div>
      <div class="campo"><span>Hora Fim</span><input type="time" data-role="fim" /></div>
      <div class="campo"><span>Total (HH:MM)</span><input data-role="total" readonly /></div>
      <button type="button" class="btn-danger remover" data-role="remover">Remover</button>
    `;

    const inInicio = row.querySelector('[data-role="inicio"]');
    const inFim = row.querySelector('[data-role="fim"]');
    const inTotal = row.querySelector('[data-role="total"]');
    const atualizar = () => { inTotal.value = calcDuracaoHHMM(inInicio.value, inFim.value); };
    inInicio.addEventListener("change", atualizar);
    inFim.addEventListener("change", atualizar);

    row.querySelector('[data-role="remover"]').addEventListener("click", ()=>row.remove());
    listaGrupos.appendChild(row);
  }

  $("grupo_status").addEventListener("change", () => {
    const sim = $("grupo_status").value === "Sim";
    gruposBox.style.display = sim ? "block" : "none";
    if(!sim) limparGrupos();
    else if(listaGrupos.children.length === 0) criarLinhaGrupo();
  });
  btnAddGrupo.addEventListener("click", criarLinhaGrupo);

  function coletarGrupos(){
    return [...listaGrupos.querySelectorAll(".group-row")]
      .map(r => ({
        grupo: r.querySelector('[data-role="grupo"]').value,
        inicio: r.querySelector('[data-role="inicio"]').value,
        fim: r.querySelector('[data-role="fim"]').value,
        total: r.querySelector('[data-role="total"]').value
      }))
      .filter(g => g.grupo || g.inicio || g.fim || g.total);
  }

  function validarGrupos(){
    if($("grupo_status").value !== "Sim") return true;
    const gs = coletarGrupos();
    if(gs.length === 0) return false;
    for(const g of gs){
      if(isBlank(g.grupo) || isBlank(g.inicio) || isBlank(g.fim) || isBlank(g.total)) return false;
    }
    return true;
  }

  // Boxes Sim/N√£o
  $("insp_status").addEventListener("change", () => {
    const sim = $("insp_status").value === "Sim";
    $("insp_box").style.display = sim ? "block" : "none";
    if(!sim) $("insp_dados").value = "";
  });
  $("medir_status").addEventListener("change", () => {
    const sim = $("medir_status").value === "Sim";
    $("medir_box").style.display = sim ? "block" : "none";
    if(!sim) $("medir_dados").value = "";
  });
  $("hid_status").addEventListener("change", () => {
    const sim = $("hid_status").value === "Sim";
    $("hid_box").style.display = sim ? "block" : "none";
    if(!sim) $("hid_dados").value = "";
  });
  $("mat_status").addEventListener("change", () => {
    const sim = $("mat_status").value === "Sim";
    $("mat_box").style.display = sim ? "block" : "none";
    if(!sim) $("mat_dados").value = "";
  });

  // Assinatura touch + mouse (mantido)
  const canvas = $("sign");
  const ctx = canvas.getContext("2d");

  function resizeCanvas(){
    const r = window.devicePixelRatio || 1;
    canvas.width = canvas.offsetWidth * r;
    canvas.height = canvas.offsetHeight * r;
    ctx.setTransform(r,0,0,r,0,0);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  let desenhando = false;

  function getPos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]){
      return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
    }
    return [e.clientX - rect.left, e.clientY - rect.top];
  }

  function startDraw(e){
    e.preventDefault();
    desenhando = true;
    ctx.beginPath();
    const [x,y] = getPos(e);
    ctx.moveTo(x,y);
  }
  function moveDraw(e){
    if(!desenhando) return;
    e.preventDefault();
    const [x,y] = getPos(e);
    ctx.lineTo(x,y);
    ctx.stroke();
  }
  function endDraw(){ desenhando = false; }

  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", moveDraw);
  canvas.addEventListener("mouseup", endDraw);
  canvas.addEventListener("mouseleave", endDraw);
  canvas.addEventListener("touchstart", startDraw, {passive:false});
  canvas.addEventListener("touchmove", moveDraw, {passive:false});
  canvas.addEventListener("touchend", endDraw);

  $("limpar").addEventListener("click", () => ctx.clearRect(0,0,canvas.width,canvas.height));

  function assinaturaVazia(){
    const pixels = ctx.getImageData(0,0,canvas.width,canvas.height).data;
    for(let i=3;i<pixels.length;i+=4){
      if(pixels[i] !== 0) return false;
    }
    return true;
  }

  // Fotos
  let imagens = [];
  $("fotos").addEventListener("change", (e) => {
    imagens = [];
    $("preview").innerHTML = "";
    [...e.target.files].forEach(file => {
      const r = new FileReader();
      r.onload = (x) => {
        imagens.push({ dataUrl: x.target.result, name: file.name });
        const im = document.createElement("img");
        im.src = x.target.result;
        $("preview").appendChild(im);
      };
      r.readAsDataURL(file);
    });
  });

  // PDF helpers
  function loadImage(dataUrl){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = dataUrl;
    });
  }
  function fitRect(imgW, imgH, boxW, boxH){
    const imgRatio = imgW / imgH;
    const boxRatio = boxW / boxH;
    let w, h;
    if(imgRatio > boxRatio){ w = boxW; h = boxW / imgRatio; }
    else { h = boxH; w = boxH * imgRatio; }
    return { w, h };
  }
  function ensureSpace(doc, y, needed, topY=20, bottomLimit=280){
    if(y + needed > bottomLimit){ doc.addPage(); return topY; }
    return y;
  }
  async function fetchAsDataURL(url){
    const res = await fetch(url);
    const blob = await res.blob();
    return await new Promise((resolve)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.readAsDataURL(blob);
    });
  }

  function validarFormulario(){
    if(isBlank($("instalacao").value) || isBlank($("municipio").value) || isBlank($("os").value)) return {ok:false,msg:"Preencha Instala√ß√£o, Munic√≠pio e OS SAP."};
    if(isBlank($("hora_inicio").value) || isBlank($("hora_fim").value)) return {ok:false,msg:"Preencha Hor√°rio inicial e Hor√°rio final da atividade."};
    atualizarTempoAtividade();
    if(isBlank($("tempo_atividade").value)) return {ok:false,msg:"Verifique os hor√°rios da atividade."};

    if(isBlank($("nome1").value) || isBlank($("nome2").value)) return {ok:false,msg:"Preencha Nome 1 e Nome 2."};
    if(isBlank($("apr").value) || isBlank($("lpe").value) || isBlank($("pet").value)) return {ok:false,msg:"Preencha APR, LPE e PET."};
    if(isBlank($("grupo_status").value)) return {ok:false,msg:"Informe a Indisponibilidade Esta√ß√£o/Grupo (Sim/N√£o)."};
    if(!validarGrupos()) return {ok:false,msg:"Preencha os grupos com in√≠cio/fim/total."};

    if(isBlank($("insp_status").value) || ($("insp_status").value==="Sim" && isBlank($("insp_dados").value))) return {ok:false,msg:"Preencha Inspe√ß√£o."};
    if(isBlank($("medir_status").value) || ($("medir_status").value==="Sim" && isBlank($("medir_dados").value))) return {ok:false,msg:"Preencha Grandezas El√©tricas."};
    if(isBlank($("hid_status").value) || ($("hid_status").value==="Sim" && isBlank($("hid_dados").value))) return {ok:false,msg:"Preencha Inspe√ß√£o Hidr√°ulica."};
    if(isBlank($("mat_status").value) || ($("mat_status").value==="Sim" && isBlank($("mat_dados").value))) return {ok:false,msg:"Preencha Materiais."};

    if(isBlank($("ocorrencia").value) || isBlank($("resumo").value)) return {ok:false,msg:"Preencha Ocorr√™ncia e Situa√ß√£o encontrada."};
    if(isBlank($("responsavel").value)) return {ok:false,msg:"Preencha o Respons√°vel."};

    if(imagens.length === 0) return {ok:false,msg:"Inclua pelo menos 1 foto."};
    if(assinaturaVazia()) return {ok:false,msg:"Assinatura obrigat√≥ria."};

    return {ok:true,msg:"OK"};
  }

  function buildWhatsText(){
    const parts = [];
    parts.push("OM RP ENGENHARIA");
    parts.push(`OS: ${$("os").value}`);
    parts.push(`Instala√ß√£o: ${$("instalacao").value}`);
    parts.push(`Munic√≠pio: ${$("municipio").value}`);
    parts.push(`Data: ${$("data").value || ""}`);
    parts.push(`Hor√°rio inicial: ${$("hora_inicio").value}`);
    parts.push(`Hor√°rio final: ${$("hora_fim").value}`);
    parts.push(`Tempo de atividade: ${$("tempo_atividade").value}`);
    parts.push(`Equipe: ${listarEquipe().join(" / ")}`);
    parts.push(`Indisponibilidade Esta√ß√£o/Grupo: ${$("grupo_status").value}`);
    if($("grupo_status").value === "Sim"){
      coletarGrupos().forEach((g, idx)=>parts.push(`#${idx+1} - ${g.grupo} ${g.inicio}‚Üí${g.fim} (${g.total})`));
    }
    parts.push(`Inspe√ß√£o: ${$("insp_status").value}`);
    if($("insp_status").value==="Sim") parts.push(`Inspe√ß√£o: ${$("insp_dados").value}`);
    parts.push(`Grandezas el√©tricas: ${$("medir_status").value}`);
    if($("medir_status").value==="Sim") parts.push(`Medi√ß√µes el√©tricas: ${$("medir_dados").value}`);
    parts.push(`Inspe√ß√£o hidr√°ulica: ${$("hid_status").value}`);
    if($("hid_status").value==="Sim") parts.push(`Medi√ß√µes hidr√°ulicas: ${$("hid_dados").value}`);
    parts.push(`Materiais: ${$("mat_status").value}`);
    if($("mat_status").value==="Sim") parts.push(`Materiais: ${$("mat_dados").value}`);
    parts.push(`Ocorr√™ncia: ${$("ocorrencia").value}`);
    parts.push(`Situa√ß√£o encontrada: ${$("resumo").value}`);
    if(!isBlank($("realizado").value)) parts.push(`Servi√ßo realizado: ${$("realizado").value}`);
    parts.push(`Respons√°vel: ${$("responsavel").value}`);
    return parts.join("\n");
  }

  async function gerarPDFBlob(){
    const v = validarFormulario();
    if(!v.ok){ alert(v.msg); throw new Error(v.msg); }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: "a4", compress: true });

    let logo = "";
    try { logo = await fetchAsDataURL("RP.jpg"); } catch(e) {}
    if(logo){
      try { doc.addImage(logo, "JPEG", 10, 8, 190, 22); }
      catch(e){ doc.addImage(logo, "PNG", 10, 8, 190, 22); }
    }

    doc.setFontSize(14);
    doc.text("ORDEM DE MANUTEN√á√ÉO - RP ENGENHARIA", 105, 36, { align: "center" });
    doc.setFontSize(9);
    doc.text("Desenvolvido por Lucas Moreira Rodrigues", 105, 41, { align: "center" });

    const equipe = listarEquipe().join(" / ");
    const tempoAtv = $("tempo_atividade").value;

    const dados = [
      ["Instala√ß√£o", $("instalacao").value],
      ["Munic√≠pio", $("municipio").value],
      ["OS SAP", $("os").value],
      ["Data", $("data").value || ""],
      ["Hor√°rio inicial", $("hora_inicio").value],
      ["Hor√°rio final", $("hora_fim").value],
      ["Tempo de atividade", tempoAtv],
      ["APR", $("apr").value],
      ["LPE", $("lpe").value],
      ["PET", $("pet").value],
      ["Equipe", equipe],
      ["Indisponibilidade Esta√ß√£o/Grupo", $("grupo_status").value],
      ["Inspe√ß√£o", $("insp_status").value],
      ["Grandezas el√©tricas", $("medir_status").value],
      ["Inspe√ß√£o hidr√°ulica", $("hid_status").value],
      ["Materiais", $("mat_status").value],
    ];

    if($("insp_status").value==="Sim") dados.push(["Inspe√ß√£o (descri√ß√£o)", $("insp_dados").value]);
    if($("medir_status").value==="Sim") dados.push(["Medi√ß√µes el√©tricas", $("medir_dados").value]);
    if($("hid_status").value==="Sim") dados.push(["Medi√ß√µes hidr√°ulicas", $("hid_dados").value]);
    if($("mat_status").value==="Sim") dados.push(["Materiais (descri√ß√£o)", $("mat_dados").value]);

    doc.autoTable({
      startY: 46,
      head: [["Campo", "Valor"]],
      body: dados,
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [11, 61, 145] },
      theme: "grid"
    });

    let y = doc.lastAutoTable.finalY + 6;

    if($("grupo_status").value === "Sim"){
      const body = coletarGrupos().map(g => [g.grupo, g.inicio, g.fim, g.total]);
      doc.setFontSize(11);
      doc.text("Detalhamento de Indisponibilidade - Esta√ß√£o/Grupo", 10, y);
      y += 2;

      doc.autoTable({
        startY: y + 2,
        head: [["Grupo", "Hora In√≠cio", "Hora Fim", "Total (HH:MM)"]],
        body,
        styles: { fontSize: 9, cellPadding: 2 },
        headStyles: { fillColor: [11, 61, 145] },
        theme: "grid"
      });
      y = doc.lastAutoTable.finalY + 6;
    }

    doc.setFontSize(11);
    doc.text("Servi√ßos", 10, y);
    y += 4;

    const blocos = [
      ["Ocorr√™ncia", $("ocorrencia").value],
      ["Situa√ß√£o encontrada", $("resumo").value],
      ["Servi√ßo realizado", $("realizado").value || ""]
    ];

    doc.setFontSize(9);
    for(const [tit, txt] of blocos){
      y = ensureSpace(doc, y, 25, 20, 280);
      doc.setFont(undefined, "bold");
      doc.text(tit + ":", 10, y);
      y += 4;
      doc.setFont(undefined, "normal");
      const lines = doc.splitTextToSize(txt || "", 190);
      doc.text(lines, 10, y);
      y += Math.max(6, lines.length * 4) + 3;
    }

    y = ensureSpace(doc, y, 45, 20, 280);
    doc.setFont(undefined, "bold");
    doc.text("Respons√°vel: ", 10, y);
    doc.setFont(undefined, "normal");
    doc.text($("responsavel").value, 35, y);
    y += 8;

    doc.setFont(undefined, "bold");
    doc.text("Assinatura:", 10, y);
    y += 2;

    const signData = canvas.toDataURL("image/png");
    doc.addImage(signData, "PNG", 10, y, 80, 30);
    y += 38;

    doc.setFont(undefined, "bold");
    doc.setFontSize(11);
    doc.text("Fotos", 10, y);
    doc.setFont(undefined, "normal");
    y += 6;

    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const marginX = 10;
    const marginTop = 20;
    const marginBottom = 15;
    const boxW = pageW - marginX*2;
    const boxH = 120;

    for(let i=0;i<imagens.length;i++){
      y = ensureSpace(doc, y, (boxH + 14), marginTop, pageH - marginBottom);
      doc.setFontSize(9);
      doc.text(`Foto ${i+1}`, marginX, y);
      y += 4;

      const imgEl = await loadImage(imagens[i].dataUrl);
      const fitted = fitRect(imgEl.naturalWidth, imgEl.naturalHeight, boxW, boxH);
      const xImg = marginX + (boxW - fitted.w)/2;
      const yImg = y + (boxH - fitted.h)/2;

      doc.setDrawColor(220);
      doc.rect(marginX, y, boxW, boxH);

      try{ doc.addImage(imagens[i].dataUrl, "JPEG", xImg, yImg, fitted.w, fitted.h, undefined, "FAST"); }
      catch(e){ doc.addImage(imagens[i].dataUrl, "PNG", xImg, yImg, fitted.w, fitted.h); }

      y += boxH + 8;
    }

    const osSafe = limparTextoArquivo($("os").value) || "SEM_OS";
    const filename = `OM_${dataHoraArquivo()}_${osSafe}.pdf`;
    const blob = doc.output("blob");
    return { blob, filename };
  }

  async function gerarPDF(){
    const { blob, filename } = await gerarPDFBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function gerarExcel(){
    const v = validarFormulario();
    if(!v.ok){ alert(v.msg); return; }

    const tempoAtv = $("tempo_atividade").value;
    const gruposTexto = $("grupo_status").value === "Sim"
      ? coletarGrupos().map(g => `${g.grupo} (${g.inicio}‚Äì${g.fim} = ${g.total})`).join(" | ")
      : "";

    const linhas = [
      ["RP ENGENHARIA", ""],
      ["ORDEM DE MANUTEN√á√ÉO", ""],
      ["Desenvolvido por Lucas Moreira Rodrigues", ""],
      ["", ""],
      ["Campo", "Valor"],
      ["Instala√ß√£o", $("instalacao").value],
      ["Munic√≠pio", $("municipio").value],
      ["OS SAP", $("os").value],
      ["Data", $("data").value || ""],
      ["Hor√°rio inicial", $("hora_inicio").value],
      ["Hor√°rio final", $("hora_fim").value],
      ["Tempo de atividade", tempoAtv],
      ["APR", $("apr").value],
      ["LPE", $("lpe").value],
      ["PET", $("pet").value],
      ["Equipe", listarEquipe().join(" / ")],
      ["Indisponibilidade Esta√ß√£o/Grupo", $("grupo_status").value],
      ["Grupos (detalhe)", gruposTexto],
      ["Inspe√ß√£o", $("insp_status").value],
      ["Inspe√ß√£o (descri√ß√£o)", $("insp_status").value === "Sim" ? $("insp_dados").value : ""],
      ["Grandezas el√©tricas", $("medir_status").value],
      ["Medi√ß√µes el√©tricas", $("medir_status").value === "Sim" ? $("medir_dados").value : ""],
      ["Inspe√ß√£o hidr√°ulica", $("hid_status").value],
      ["Medi√ß√µes hidr√°ulicas", $("hid_status").value === "Sim" ? $("hid_dados").value : ""],
      ["Materiais", $("mat_status").value],
      ["Materiais (descri√ß√£o)", $("mat_status").value === "Sim" ? $("mat_dados").value : ""],
      ["Ocorr√™ncia", $("ocorrencia").value],
      ["Situa√ß√£o encontrada", $("resumo").value],
      ["Servi√ßo realizado", $("realizado").value || ""],
      ["Respons√°vel", $("responsavel").value],
      ["Registro gerado em", new Date().toLocaleString("pt-BR")]
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(linhas);
    ws["!merges"] = [
      { s:{r:0,c:0}, e:{r:0,c:1} },
      { s:{r:1,c:0}, e:{r:1,c:1} },
      { s:{r:2,c:0}, e:{r:2,c:1} }
    ];
    ws["!cols"] = [{ wch: 30 }, { wch: 100 }];
    XLSX.utils.book_append_sheet(wb, ws, "OM_Controle");

    const osSafe = limparTextoArquivo($("os").value) || "SEM_OS";
    XLSX.writeFile(wb, `OM_${dataHoraArquivo()}_${osSafe}.xlsx`);
  }

  async function enviarWhats(){
    const v = validarFormulario();
    if(!v.ok){ alert(v.msg); return; }

    const texto = buildWhatsText();
    const { blob, filename } = await gerarPDFBlob();
    const file = new File([blob], filename, { type: "application/pdf" });

    if (navigator.canShare && navigator.canShare({ files: [file] })) {
      try{
        await navigator.share({ title: "OM RP Engenharia", text: texto, files: [file] });
        return;
      }catch(e){}
    }

    await gerarPDF();
    const link = "https://wa.me/" + WHATS_PHONE + "?text=" + encodeURIComponent(
      texto + "\n\nPDF gerado: " + filename + "\n(Anexe o arquivo baixado aqui.)"
    );
    window.open(link, "_blank");
  }

  $("pdf").addEventListener("click", gerarPDF);
  $("excel").addEventListener("click", gerarExcel);
  $("whats").addEventListener("click", enviarWhats);
});
</script>

</body>
</html>
