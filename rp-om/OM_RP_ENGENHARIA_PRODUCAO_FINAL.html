<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OM RP Engenharia</title>

<style>
body{font-family:Arial;background:#eef2f6;margin:0;padding:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:12px}
h2{background:#0b3d91;color:#fff;padding:8px;border-radius:6px;font-size:16px}

.grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
@media(max-width:768px){
  .grid{grid-template-columns:1fr;}
}

input,select,textarea{
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid #aaa;
}
textarea{min-height:60px}

button{
  width:100%;
  margin-top:10px;
  background:#0b3d91;
  color:#fff;
  border:none;
  padding:12px;
  border-radius:8px;
  font-size:16px;
}

canvas{
  border:1px solid #333;
  border-radius:8px;
  width:100%;
  height:180px;
  background:#fff;
  touch-action:none;
}

.photo-preview img{
  height:70px;
  margin:4px;
  border-radius:6px;
  border:1px solid #ccc;
}

.logo{max-width:180px;margin-bottom:10px}
</style>
</head>

<body>
<div class="container">

<img src="RP.jpg" class="logo">

<h2>Dados Gerais</h2>
<div class="grid">
<input id="instalacao" placeholder="Instala√ß√£o *">
<input id="municipio" placeholder="Munic√≠pio *">
<input id="os" placeholder="OS SAP *">
<input type="date" id="data">
<input type="time" id="hora">
</div>

<h2>Seguran√ßa (obrigat√≥rio)</h2>
<div class="grid">
<select id="apr"><option value="">APR?</option><option>Sim</option><option>N√£o</option></select>
<select id="lpe"><option value="">LPE?</option><option>Sim</option><option>N√£o</option></select>
<select id="pet"><option value="">PET?</option><option>Sim</option><option>N√£o</option></select>
</div>

<h2>Equipe</h2>
<div class="grid">
<input id="nome1" placeholder="Nome 1">
<input id="nome2" placeholder="Nome 2">
<input id="nome3" placeholder="Nome 3">
<input id="nome4" placeholder="Nome 4">
</div>

<h2>Grupo Parado</h2>

<div class="grid">
<input id="g1" placeholder="Grupo 1">
<input type="time" id="g1_inicio">
<input type="time" id="g1_fim">
<input id="g1_total" placeholder="Total (h)" readonly>
</div>

<div class="grid">
<input id="g2" placeholder="Grupo 2">
<input type="time" id="g2_inicio">
<input type="time" id="g2_fim">
<input id="g2_total" placeholder="Total (h)" readonly>
</div>

<div class="grid">
<input id="g3" placeholder="Grupo 3">
<input type="time" id="g3_inicio">
<input type="time" id="g3_fim">
<input id="g3_total" placeholder="Total (h)" readonly>
</div>

<div class="grid">
<input id="g4" placeholder="Grupo 4">
<input type="time" id="g4_inicio">
<input type="time" id="g4_fim">
<input id="g4_total" placeholder="Total (h)" readonly>
</div>

<h2>Servi√ßos</h2>
<textarea id="resumo" placeholder="Situa√ß√£o encontrada *"></textarea>
<textarea id="ocorrencia" placeholder="Ocorr√™ncia"></textarea>
<textarea id="realizado" placeholder="Servi√ßo realizado"></textarea>

<h2>Fotos (obrigat√≥rio)</h2>
<input type="file" id="fotos" multiple accept="image/*">
<div class="photo-preview" id="preview"></div>

<h2>Respons√°vel</h2>
<input id="responsavel" placeholder="Nome do respons√°vel *">

<h2>Assinatura</h2>
<canvas id="sign"></canvas>
<button onclick="limparAssinatura()">Limpar assinatura</button>

<button onclick="gerarPDF()">üíæ SALVAR PDF</button>
<button onclick="enviarWhats()">üì≤ ENVIAR WHATSAPP</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
// ===== ASSINATURA =====
const canvas=document.getElementById("sign");
const ctx=canvas.getContext("2d");

function resizeCanvas(){
 const r=window.devicePixelRatio||1;
 canvas.width=canvas.offsetWidth*r;
 canvas.height=canvas.offsetHeight*r;
 ctx.setTransform(r,0,0,r,0,0);
 ctx.lineWidth=2;
 ctx.lineCap="round";
}
resizeCanvas();

let draw=false;
function pos(e){
 const b=canvas.getBoundingClientRect();
 return {
  x:(e.touches?e.touches[0].clientX:e.clientX)-b.left,
  y:(e.touches?e.touches[0].clientY:e.clientY)-b.top
 };
}
canvas.addEventListener("mousedown",e=>{draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);});
canvas.addEventListener("mousemove",e=>{if(draw){const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();}});
canvas.addEventListener("mouseup",()=>draw=false);
canvas.addEventListener("touchstart",e=>{draw=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);},{passive:false});
canvas.addEventListener("touchmove",e=>{if(draw){e.preventDefault();const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();}},{passive:false});
canvas.addEventListener("touchend",()=>draw=false);

function limparAssinatura(){ctx.clearRect(0,0,canvas.width,canvas.height);}

// ===== FOTOS =====
let imagens=[];
fotos.onchange=e=>{
 imagens=[];
 preview.innerHTML="";
 [...e.target.files].forEach(f=>{
  const r=new FileReader();
  r.onload=x=>{
   imagens.push(x.target.result);
   const i=document.createElement("img");
   i.src=x.target.result;
   preview.appendChild(i);
  };
  r.readAsDataURL(f);
 });
};

// ===== TEMPO =====
function calc(i,f){
 if(!i||!f)return"";
 let [hi,mi]=i.split(":").map(Number);
 let [hf,mf]=f.split(":").map(Number);
 let t=(hf*60+mf)-(hi*60+mi);
 if(t<0)t+=1440;
 return (t/60).toFixed(2);
}
["1","2","3","4"].forEach(n=>{
 ["inicio","fim"].forEach(k=>{
  document.getElementById(`g${n}_${k}`).addEventListener("change",()=>{
   document.getElementById(`g${n}_total`).value=
   calc(
    document.getElementById(`g${n}_inicio`).value,
    document.getElementById(`g${n}_fim`).value
   );
  });
 });
});

// ===== PDF =====
function gerarPDF(){
 if(!instalacao.value||!municipio.value||!os.value||!resumo.value||
 !responsavel.value||!apr.value||!lpe.value||!pet.value||imagens.length===0){
  alert("Preencha todos os campos obrigat√≥rios");
  return;
 }

 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();

 doc.text("ORDEM DE MANUTEN√á√ÉO - RP ENGENHARIA",105,15,{align:"center"});

 doc.autoTable({
  startY:25,
  head:[["Campo","Informa√ß√£o"]],
  body:[
   ["Instala√ß√£o",instalacao.value],
   ["Munic√≠pio",municipio.value],
   ["OS SAP",os.value],
   ["Seguran√ßa",`APR:${apr.value} | LPE:${lpe.value} | PET:${pet.value}`],
   ["Equipe",[nome1.value,nome2.value,nome3.value,nome4.value].filter(Boolean).join(", ")],
   ["Grupo 1",`${g1.value} | ${g1_inicio.value} - ${g1_fim.value} | ${g1_total.value} h`],
   ["Grupo 2",`${g2.value} | ${g2_inicio.value} - ${g2_fim.value} | ${g2_total.value} h`],
   ["Grupo 3",`${g3.value} | ${g3_inicio.value} - ${g3_fim.value} | ${g3_total.value} h`],
   ["Grupo 4",`${g4.value} | ${g4_inicio.value} - ${g4_fim.value} | ${g4_total.value} h`],
   ["Situa√ß√£o encontrada",resumo.value],
   ["Ocorr√™ncia",ocorrencia.value],
   ["Servi√ßo realizado",realizado.value]
  ]
 });

 let y=doc.lastAutoTable.finalY+10;
 doc.text("Assinatura:",10,y);
 doc.addImage(canvas.toDataURL("image/png"),"PNG",10,y+5,70,30);

 doc.addPage();
 doc.text("Registro Fotogr√°fico",10,15);
 let x=10,yy=25;
 imagens.forEach(img=>{
  doc.addImage(img,"JPEG",x,yy,60,45);
  x+=70;
  if(x>150){x=10;yy+=55;}
 });

 // ===== NOME AUTOM√ÅTICO DO ARQUIVO =====
 const agora = new Date();
 const data = agora.toISOString().slice(0,10);
 const hora = agora.toTimeString().slice(0,5).replace(":","-");

 doc.save(`OM_RP_${data}_${hora}_OS${os.value}.pdf`);
}

// ===== WHATS =====
function enviarWhats(){
 const msg=`OS ${os.value} - ${resumo.value}`;
 window.open("https://wa.me/5511916732498?text="+encodeURIComponent(msg));
}
</script>

</body>
</html>
