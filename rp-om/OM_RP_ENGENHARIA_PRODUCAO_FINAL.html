<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OM RP Engenharia</title>

<style>
body{font-family:Arial;background:#eef2f6;margin:0;padding:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:12px}

.topo-img{width:100%;max-height:120px;object-fit:contain;display:block;margin-bottom:10px}
h2{background:#0b3d91;color:#fff;padding:8px;border-radius:6px;font-size:16px}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

.campo{display:flex;flex-direction:column;font-size:13px;font-weight:bold}
.campo span{margin-bottom:2px;color:#0b3d91}

input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #aaa;font-weight:normal}
textarea{min-height:60px}

button{width:100%;margin-top:10px;background:#0b3d91;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer}
.btn-sec{background:#1d6fd8}
.btn-danger{background:#b42318}

canvas{border:1px solid #333;border-radius:8px;width:100%;height:180px;background:#fff;touch-action:none}
.photo-preview img{height:70px;margin:4px;border-radius:6px;border:1px solid #ccc}

.nota{font-size:12px;color:#444;margin-top:8px}
.group-row{
  display:grid;
  grid-template-columns: 1.2fr 1fr 1fr 1fr 0.8fr;
  gap:8px;
  align-items:end;
  margin-top:8px;
}
@media(max-width:768px){.group-row{grid-template-columns:1fr}}
.group-row .remover{height:38px;margin-top:0}
.hr{border:0;border-top:1px solid #e4e7ec;margin:10px 0}
</style>
</head>

<body>
<div class="container">

<img src="RP.jpg" class="topo-img" alt="RP Engenharia">

<h2>Dados Gerais</h2>
<div class="grid">
  <div class="campo"><span>Instala√ß√£o *</span><input id="instalacao"></div>
  <div class="campo"><span>Munic√≠pio *</span><input id="municipio"></div>
  <div class="campo"><span>OS SAP *</span><input id="os"></div>
  <div class="campo"><span>Data</span><input type="date" id="data"></div>
  <div class="campo"><span>Hora</span><input type="time" id="hora"></div>
</div>

<h2>Atividade necessita de:</h2>
<div class="grid">
  <div class="campo"><span>APR</span><select id="apr"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>LPE</span><select id="lpe"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>PET</span><select id="pet"><option value="">Selecione</option><option>Sim</option><option>N√£o</option></select></div>
</div>

<h2>Equipe</h2>
<div class="grid">
  <div class="campo"><span>Nome 1</span><input id="nome1"></div>
  <div class="campo"><span>Nome 2</span><input id="nome2"></div>
  <div class="campo"><span>Nome 3</span><input id="nome3"></div>
  <div class="campo"><span>Nome 4</span><input id="nome4"></div>
</div>

<h2>Esta√ß√£o / Grupos</h2>
<div class="campo">
  <span>Esta√ß√£o/Grupo permaneceu desligado ou indispon√≠vel durante a manuten√ß√£o? *</span>
  <select id="grupo_status">
    <option value="">Selecione</option>
    <option>N√£o</option>
    <option>Sim</option>
  </select>
</div>

<div id="grupos_box" style="display:none; margin-top:10px;">
  <div class="campo">
    <span>Grupos indispon√≠veis (adicione quantos forem necess√°rios)</span>
    <button type="button" class="btn-sec" id="btn_add_grupo">‚ûï Adicionar Grupo</button>
  </div>

  <div id="lista_grupos"></div>

  <div class="hr"></div>

  <div class="grid">
    <div class="campo">
      <span>Total Geral (h)</span>
      <input id="g_total_geral" readonly>
    </div>
  </div>
</div>

<!-- ===== NOVO CAMPO: GRANDEZAS EL√âTRICAS (OBRIGAT√ìRIO) ===== -->
<h2>Grandezas El√©tricas</h2>
<div class="campo">
  <span>Necess√°rio medir grandezas el√©tricas? *</span>
  <select id="medir_status">
    <option value="">Selecione</option>
    <option>N√£o</option>
    <option>Sim</option>
  </select>
</div>

<div id="medir_box" style="display:none; margin-top:8px;">
  <div class="campo">
    <span>Preencher medi√ß√µes (ex.: V, A, kW, FP, Hz, etc.) *</span>
    <textarea id="medir_dados" placeholder="Ex.: Tens√£o: 380V | Corrente: 22A | Pot√™ncia: 11kW | FP: 0,92 | Frequ√™ncia: 60Hz"></textarea>
  </div>
</div>
<!-- ===== /NOVO CAMPO ===== -->

<h2>Servi√ßos</h2>
<div class="campo"><span>Situa√ß√£o encontrada *</span><textarea id="resumo"></textarea></div>
<div class="campo"><span>Ocorr√™ncia</span><textarea id="ocorrencia"></textarea></div>
<div class="campo"><span>Servi√ßo realizado</span><textarea id="realizado"></textarea></div>

<h2>Fotos (obrigat√≥rio)</h2>
<input type="file" id="fotos" multiple accept="image/*">
<div class="photo-preview" id="preview"></div>

<h2>Respons√°vel</h2>
<div class="campo"><span>Nome do respons√°vel *</span><input id="responsavel"></div>

<h2>Assinatura</h2>
<canvas id="sign"></canvas>
<button type="button" onclick="limparAssinatura()">Limpar assinatura</button>

<button type="button" onclick="gerarPDF()">üíæ SALVAR PDF</button>
<button type="button" onclick="enviarWhats()">üì≤ ENVIAR WHATSAPP</button>

<div class="nota">
  * No celular, o envio tenta anexar o PDF automaticamente via compartilhamento. No PC, o WhatsApp abre com a mensagem pronta e o anexo √© manual (limita√ß√£o do WhatsApp Web).
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
// ========= CONFIG =========
const WHATS_PHONE = "5511981374513"; // troque aqui

// ========= NOME DO ARQUIVO (DATA+HORA) =========
function dataHoraArquivo(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}${mm}${dd}_${hh}${mi}`;
}
function limparTextoArquivo(s){
  return (s || "")
    .toString()
    .trim()
    .replace(/[^\w\-]+/g, "_")
    .replace(/_+/g, "_")
    .replace(/^_+|_+$/g, "");
}
function isBlank(v){ return !v || !String(v).trim(); }

// ========= C√ÅLCULO TEMPO =========
function calc(i,f){
  if(!i||!f) return "";
  let [hi,mi] = i.split(":").map(Number);
  let [hf,mf] = f.split(":").map(Number);
  let t = (hf*60+mf) - (hi*60+mi);
  if(t < 0) t += 1440;
  return (t/60).toFixed(2);
}

// ========= GRUPOS (M√öLTIPLOS) =========
const gruposBox = document.getElementById("grupos_box");
const listaGrupos = document.getElementById("lista_grupos");
const totalGeral = document.getElementById("g_total_geral");
const btnAddGrupo = document.getElementById("btn_add_grupo");

function limparGrupos(){
  listaGrupos.innerHTML = "";
  totalGeral.value = "";
}

function somarTotais(){
  let soma = 0;
  const totals = listaGrupos.querySelectorAll('[data-role="total"]');
  totals.forEach(inp=>{
    const v = parseFloat((inp.value || "").replace(",", "."));
    if(!isNaN(v)) soma += v;
  });
  totalGeral.value = soma ? soma.toFixed(2) : "";
}

function criarLinhaGrupo(){
  const row = document.createElement("div");
  row.className = "group-row";

  row.innerHTML = `
    <div class="campo">
      <span>Grupo</span>
      <select data-role="grupo">
        <option value="">Selecione</option>
        <option>Grupo 1</option>
        <option>Grupo 2</option>
        <option>Grupo 3</option>
        <option>Grupo 4</option>
      </select>
    </div>

    <div class="campo">
      <span>Hora In√≠cio</span>
      <input type="time" data-role="inicio">
    </div>

    <div class="campo">
      <span>Hora Fim</span>
      <input type="time" data-role="fim">
    </div>

    <div class="campo">
      <span>Total (h)</span>
      <input data-role="total" readonly>
    </div>

    <button type="button" class="btn-danger remover" data-role="remover">Remover</button>
  `;

  const inInicio = row.querySelector('[data-role="inicio"]');
  const inFim = row.querySelector('[data-role="fim"]');
  const inTotal = row.querySelector('[data-role="total"]');
  const btnRemover = row.querySelector('[data-role="remover"]');

  function atualizarTotalLinha(){
    inTotal.value = calc(inInicio.value, inFim.value);
    somarTotais();
  }

  inInicio.addEventListener("change", atualizarTotalLinha);
  inFim.addEventListener("change", atualizarTotalLinha);

  btnRemover.addEventListener("click", () => {
    row.remove();
    somarTotais();
  });

  listaGrupos.appendChild(row);
  return row;
}

grupo_status.addEventListener("change", () => {
  const sim = grupo_status.value === "Sim";
  gruposBox.style.display = sim ? "block" : "none";
  if(!sim){
    limparGrupos();
  }else{
    if(listaGrupos.children.length === 0){
      criarLinhaGrupo();
    }
  }
});

btnAddGrupo.addEventListener("click", () => criarLinhaGrupo());

// ========= NOVO CAMPO: MEDIR GRANDEZAS (OBRIGAT√ìRIO) =========
const medirStatus = document.getElementById("medir_status");
const medirBox = document.getElementById("medir_box");
const medirDados = document.getElementById("medir_dados");

medirStatus.addEventListener("change", () => {
  const sim = medirStatus.value === "Sim";
  medirBox.style.display = sim ? "block" : "none";
  if(!sim){
    medirDados.value = "";
  }
});

// ========= ASSINATURA (MOUSE + TOUCH) =========
const canvas = document.getElementById("sign");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  const r = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * r;
  canvas.height = canvas.offsetHeight * r;
  ctx.setTransform(r,0,0,r,0,0);
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.strokeStyle = "#000";
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let desenhando = false;

function getPos(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches && e.touches[0]){
    return [e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top];
  }
  return [e.clientX - rect.left, e.clientY - rect.top];
}
function startDraw(e){
  e.preventDefault();
  desenhando = true;
  ctx.beginPath();
  const [x,y] = getPos(e);
  ctx.moveTo(x,y);
}
function moveDraw(e){
  if(!desenhando) return;
  e.preventDefault();
  const [x,y] = getPos(e);
  ctx.lineTo(x,y);
  ctx.stroke();
}
function endDraw(){ desenhando = false; }

canvas.addEventListener("mousedown", startDraw);
canvas.addEventListener("mousemove", moveDraw);
canvas.addEventListener("mouseup", endDraw);
canvas.addEventListener("mouseleave", endDraw);

canvas.addEventListener("touchstart", startDraw, {passive:false});
canvas.addEventListener("touchmove", moveDraw, {passive:false});
canvas.addEventListener("touchend", endDraw);

function limparAssinatura(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

// ========= FOTOS =========
let imagens = []; // {dataUrl, name}
fotos.onchange = (e) => {
  imagens = [];
  preview.innerHTML = "";
  [...e.target.files].forEach(file=>{
    const r = new FileReader();
    r.onload = (x)=>{
      imagens.push({ dataUrl: x.target.result, name: file.name });
      const im = document.createElement("img");
      im.src = x.target.result;
      preview.appendChild(im);
    };
    r.readAsDataURL(file);
  });
};

// ========= HELPERS PDF =========
async function fetchAsDataURL(url){
  const res = await fetch(url);
  const blob = await res.blob();
  return await new Promise((resolve)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.readAsDataURL(blob);
  });
}

function coletarGrupos(){
  const rows = [...listaGrupos.querySelectorAll(".group-row")];
  const out = [];
  rows.forEach(r=>{
    const grupo = r.querySelector('[data-role="grupo"]').value;
    const inicio = r.querySelector('[data-role="inicio"]').value;
    const fim = r.querySelector('[data-role="fim"]').value;
    const total = r.querySelector('[data-role="total"]').value;
    if(grupo || inicio || fim || total){
      out.push({grupo, inicio, fim, total});
    }
  });
  return out;
}

function validarGrupos(){
  if(grupo_status.value !== "Sim") return true;
  const gs = coletarGrupos();
  if(gs.length === 0) return false;

  // exige que cada linha informada tenha grupo e hor√°rios
  for(const g of gs){
    if(isBlank(g.grupo)) return false;
    if(isBlank(g.inicio) || isBlank(g.fim)) return false;
    if(isBlank(g.total)) return false;
  }
  return true;
}

function validarGrandezas(){
  if(isBlank(medirStatus.value)) return false;
  if(medirStatus.value === "Sim" && isBlank(medirDados.value)) return false;
  return true;
}

function buildWhatsText(){
  const parts = [];
  parts.push("OM RP ENGENHARIA");
  parts.push(`OS: ${os.value}`);
  parts.push(`Instala√ß√£o: ${instalacao.value}`);
  parts.push(`Munic√≠pio: ${municipio.value}`);
  if(!isBlank(data.value)) parts.push(`Data: ${data.value}`);
  if(!isBlank(hora.value)) parts.push(`Hora: ${hora.value}`);

  if(grupo_status.value === "Sim"){
    const gs = coletarGrupos();
    parts.push(`Grupos indispon√≠veis: Sim`);
    gs.forEach((g, idx)=>{
      parts.push(`#${idx+1} - ${g.grupo} - In√≠cio ${g.inicio} - Fim ${g.fim} - Total ${g.total} h`);
    });
    if(totalGeral.value) parts.push(`Total geral: ${totalGeral.value} h`);
  } else {
    parts.push(`Grupos indispon√≠veis: ${grupo_status.value || ""}`);
  }

  parts.push(`Medir grandezas el√©tricas: ${medirStatus.value}`);
  if(medirStatus.value === "Sim"){
    parts.push(`Medi√ß√µes: ${medirDados.value}`);
  }

  if(!isBlank(resumo.value)) parts.push(`Situa√ß√£o: ${resumo.value}`);
  if(!isBlank(ocorrencia.value)) parts.push(`Ocorr√™ncia: ${ocorrencia.value}`);
  if(!isBlank(realizado.value)) parts.push(`Servi√ßo realizado: ${realizado.value}`);
  parts.push(`Respons√°vel: ${responsavel.value}`);
  return parts.join("\n");
}

// ========= PDF (gera + retorna blob) =========
async function gerarPDFBlob(){
  if(isBlank(instalacao.value) || isBlank(municipio.value) || isBlank(os.value) || isBlank(resumo.value) || isBlank(responsavel.value)){
    alert("Preencha os campos obrigat√≥rios: Instala√ß√£o, Munic√≠pio, OS SAP, Situa√ß√£o encontrada e Respons√°vel.");
    throw new Error("Campos obrigat√≥rios n√£o preenchidos.");
  }
  if(imagens.length === 0){
    alert("Inclua pelo menos 1 foto (obrigat√≥rio).");
    throw new Error("Sem fotos.");
  }
  if(isBlank(grupo_status.value)){
    alert("Informe se houve grupos indispon√≠veis (Selecione Sim ou N√£o).");
    throw new Error("Grupo status obrigat√≥rio.");
  }
  if(!validarGrupos()){
    alert("Preencha os grupos indispon√≠veis: Grupo + Hora In√≠cio + Hora Fim (para cada linha).");
    throw new Error("Grupos inv√°lidos.");
  }
  if(!validarGrandezas()){
    alert("Preencha 'Necess√°rio medir grandezas el√©tricas?' e, se Sim, informe as medi√ß√µes.");
    throw new Error("Grandezas el√©tricas obrigat√≥rio.");
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: "a4", compress: true });

  let logo = "";
  try { logo = await fetchAsDataURL("RP.jpg"); } catch(e) {}
  if(logo){
    try { doc.addImage(logo, "JPEG", 10, 8, 55, 18); }
    catch(e){ doc.addImage(logo, "PNG", 10, 8, 55, 18); }
  }

  doc.setFontSize(14);
  doc.text("ORDEM DE MANUTEN√á√ÉO - RP ENGENHARIA", 105, 18, { align: "center" });
  doc.setFontSize(9);
  doc.text("Desenvolvido por Lucas Moreira Rodrigues", 105, 24, { align: "center" });

  const equipe = [nome1.value, nome2.value, nome3.value, nome4.value].filter(v=>!isBlank(v)).join(" / ");
  const dados = [
    ["Instala√ß√£o", instalacao.value],
    ["Munic√≠pio", municipio.value],
    ["OS SAP", os.value],
    ["Data", data.value || ""],
    ["Hora", hora.value || ""],
    ["APR", apr.value || ""],
    ["LPE", lpe.value || ""],
    ["PET", pet.value || ""],
    ["Equipe", equipe],
    ["Grupos indispon√≠veis", grupo_status.value],
    ["Medir grandezas el√©tricas", medirStatus.value],
  ];
  if(medirStatus.value === "Sim"){
    dados.push(["Medi√ß√µes", medirDados.value]);
  }
  if(grupo_status.value === "Sim" && totalGeral.value){
    dados.push(["Total geral (h)", totalGeral.value]);
  }

  doc.autoTable({
    startY: 30,
    head: [["Campo", "Valor"]],
    body: dados,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [11, 61, 145] },
    theme: "grid"
  });

  let y = doc.lastAutoTable.finalY + 6;

  // Tabela de grupos, se houver
  const gruposDetalhe = [];
  if(grupo_status.value === "Sim"){
    const gs = coletarGrupos();
    gs.forEach(g=>gruposDetalhe.push([g.grupo, g.inicio, g.fim, g.total]));
  }
  if(gruposDetalhe.length){
    doc.setFontSize(11);
    doc.text("Detalhamento de Grupos Indispon√≠veis", 10, y);
    y += 2;

    doc.autoTable({
      startY: y + 2,
      head: [["Grupo", "Hora In√≠cio", "Hora Fim", "Total (h)"]],
      body: gruposDetalhe,
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [11, 61, 145] },
      theme: "grid"
    });
    y = doc.lastAutoTable.finalY + 6;
  }

  // Servi√ßos
  doc.setFontSize(11);
  doc.text("Servi√ßos", 10, y);
  y += 4;

  const blocos = [
    ["Situa√ß√£o encontrada", resumo.value],
    ["Ocorr√™ncia", ocorrencia.value || ""],
    ["Servi√ßo realizado", realizado.value || ""]
  ];

  doc.setFontSize(9);
  for(const [tit, txt] of blocos){
    doc.setFont(undefined, "bold");
    doc.text(tit + ":", 10, y);
    y += 4;
    doc.setFont(undefined, "normal");

    const lines = doc.splitTextToSize(txt || "", 190);
    doc.text(lines, 10, y);
    y += Math.max(6, lines.length * 4) + 2;

    if(y > 250){
      doc.addPage();
      y = 20;
    }
  }

  // Respons√°vel + assinatura
  doc.setFont(undefined, "bold");
  doc.text("Respons√°vel: ", 10, y);
  doc.setFont(undefined, "normal");
  doc.text(responsavel.value, 35, y);
  y += 8;

  doc.setFont(undefined, "bold");
  doc.text("Assinatura:", 10, y);
  doc.setFont(undefined, "normal");
  y += 2;

  const signData = canvas.toDataURL("image/png");
  doc.addImage(signData, "PNG", 10, y, 80, 30);
  y += 38;

  // Fotos
  doc.setFont(undefined, "bold");
  doc.text("Fotos", 10, y);
  doc.setFont(undefined, "normal");
  y += 4;

  for(let i=0; i<imagens.length; i++){
    if(y > 240){
      doc.addPage();
      y = 20;
    }
    doc.setFontSize(9);
    doc.text(`Foto ${i+1}`, 10, y);
    y += 2;

    const imgData = imagens[i].dataUrl;
    try { doc.addImage(imgData, "JPEG", 10, y, 180, 90, undefined, "FAST"); }
    catch(e){ doc.addImage(imgData, "PNG", 10, y, 180, 90); }

    y += 98;
  }

  const osSafe = limparTextoArquivo(os.value) || "SEM_OS";
  const filename = `OM_${dataHoraArquivo()}_${osSafe}.pdf`;
  const blob = doc.output("blob");
  return { blob, filename };
}

// ========= SALVAR PDF =========
async function gerarPDF(){
  const { blob, filename } = await gerarPDFBlob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ========= ENVIAR WHATS =========
async function enviarWhats(){
  const texto = buildWhatsText();
  const { blob, filename } = await gerarPDFBlob();
  const file = new File([blob], filename, { type: "application/pdf" });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try{
      await navigator.share({
        title: "OM RP Engenharia",
        text: texto,
        files: [file]
      });
      return;
    }catch(e){}
  }

  await gerarPDF();
  const link = "https://wa.me/" + WHATS_PHONE + "?text=" + encodeURIComponent(
    texto + "\n\nPDF gerado: " + filename + "\n(Anexe o arquivo baixado aqui.)"
  );
  window.open(link, "_blank");
}
</script>

</body>
</html>
