<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OM RP Engenharia</title>

<style>
body{font-family:Arial;background:#eef2f6;margin:0;padding:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:12px}

.topo-img{width:100%;height:130px;object-fit:cover;border-radius:10px;margin-bottom:10px}

h2{background:#0b3d91;color:#fff;padding:8px;border-radius:6px;font-size:16px;margin-top:16px}

.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

.campo{display:flex;flex-direction:column;font-size:13px;font-weight:bold}
.campo span{color:#0b3d91;margin-bottom:2px}

input,select,textarea{padding:8px;border-radius:6px;border:1px solid #aaa;width:100%}
textarea{min-height:60px}

button{width:100%;margin-top:10px;background:#0b3d91;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer}
.btn-sec{background:#1d6fd8}
.btn-del{background:#b42318}

canvas{border:1px solid #333;border-radius:8px;width:100%;height:180px}

.photo-preview img{height:70px;margin:4px;border-radius:6px;border:1px solid #ccc}
.grupo-row,.team-extra{display:grid;gap:8px;margin-top:6px}
.grupo-row{grid-template-columns:1.3fr 1fr 1fr 1fr .6fr}
.team-extra{grid-template-columns:1fr .6fr}
@media(max-width:768px){.grupo-row,.team-extra{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="container">

<img src="RP.jpg" class="topo-img">

<h2>Dados Gerais</h2>
<div class="grid">
  <div class="campo"><span>Instala√ß√£o *</span><input id="instalacao"></div>
  <div class="campo"><span>Munic√≠pio *</span><input id="municipio"></div>
  <div class="campo"><span>OS SAP *</span><input id="os"></div>
  <div class="campo"><span>Data</span><input type="date" id="data"></div>
  <div class="campo"><span>Hora</span><input type="time" id="hora"></div>
</div>

<h2>Documenta√ß√£o de Seguran√ßa</h2>
<div class="grid">
  <div class="campo"><span>APR *</span><select id="apr"><option></option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>LPE *</span><select id="lpe"><option></option><option>Sim</option><option>N√£o</option></select></div>
  <div class="campo"><span>PET *</span><select id="pet"><option></option><option>Sim</option><option>N√£o</option></select></div>
</div>

<h2>Equipe</h2>
<div class="grid">
  <div class="campo"><span>Nome 1 *</span><input id="nome1"></div>
  <div class="campo"><span>Nome 2 *</span><input id="nome2"></div>
</div>
<div id="extras"></div>
<button class="btn-sec" onclick="addMembro()">‚ûï Adicionar membro</button>

<h2>Esta√ß√£o / Grupos</h2>
<div class="campo">
  <span>Grupo ficou indispon√≠vel? *</span>
  <select id="grupo_status" onchange="toggleGrupos()">
    <option></option><option>N√£o</option><option>Sim</option>
  </select>
</div>

<div id="grupos_box" style="display:none">
  <button class="btn-sec" onclick="addGrupo()">‚ûï Adicionar grupo</button>
  <div id="lista_grupos"></div>
</div>

<h2>Grandezas El√©tricas</h2>
<div class="campo">
<select id="eletrica_status" onchange="toggleBox('eletrica_box',this.value)">
<option></option><option>N√£o</option><option>Sim</option>
</select>
</div>
<div id="eletrica_box" style="display:none"><textarea id="eletrica_dados"></textarea></div>

<h2>Inspe√ß√£o Hidr√°ulica</h2>
<div class="campo">
<select id="hid_status" onchange="toggleBox('hid_box',this.value)">
<option></option><option>N√£o</option><option>Sim</option>
</select>
</div>
<div id="hid_box" style="display:none"><textarea id="hid_dados"></textarea></div>

<h2>Materiais</h2>
<div class="campo">
<select id="mat_status" onchange="toggleBox('mat_box',this.value)">
<option></option><option>N√£o</option><option>Sim</option>
</select>
</div>
<div id="mat_box" style="display:none"><textarea id="mat_dados"></textarea></div>

<h2>Servi√ßos</h2>
<textarea id="ocorrencia" placeholder="Ocorr√™ncia *"></textarea>
<textarea id="resumo" placeholder="Situa√ß√£o encontrada *"></textarea>
<textarea id="realizado" placeholder="Servi√ßo realizado"></textarea>

<h2>Fotos *</h2>
<input type="file" id="fotos" multiple accept="image/*">
<div class="photo-preview" id="preview"></div>

<h2>Respons√°vel *</h2>
<input id="responsavel">

<h2>Assinatura *</h2>
<canvas id="sign"></canvas>
<button onclick="limparSign()">Limpar assinatura</button>

<button onclick="gerarPDF()">üíæ SALVAR PDF</button>
<button onclick="gerarExcel()">üìä SALVAR EXCEL</button>
<button onclick="enviarWhats()">üì≤ ENVIAR WHATSAPP</button>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// ================== UTIL ==================
const $=id=>document.getElementById(id);
const obrig=v=>v&&v.trim();
function dataHoraArquivo(){
 const d=new Date();
 return d.getFullYear()+(""+(d.getMonth()+1)).padStart(2,0)+(""+d.getDate()).padStart(2,0)+"_"+(""+d.getHours()).padStart(2,0)+(""+d.getMinutes()).padStart(2,0);
}
function toggleBox(id,v){$(id).style.display=v==="Sim"?"block":"none"}

// ================== EQUIPE ==================
function addMembro(){
 const d=document.createElement("div");
 d.className="team-extra";
 d.innerHTML=`<input placeholder="Nome adicional"><button class="btn-del" onclick="this.parentNode.remove()">X</button>`;
 $("extras").appendChild(d);
}
function listarEquipe(){
 const extras=[...$("extras").querySelectorAll("input")].map(i=>i.value).filter(obrig);
 return [$("nome1").value,$("nome2").value,...extras];
}

// ================== GRUPOS ==================
function toggleGrupos(){ $("grupos_box").style.display=$("grupo_status").value==="Sim"?"block":"none" }
function calc(i,f){
 let a=i.split(":"),b=f.split(":");
 let t=(b[0]*60+b[1]*1)-(a[0]*60+a[1]*1);
 if(t<0)t+=1440;
 return String(Math.floor(t/60)).padStart(2,0)+":"+String(t%60).padStart(2,0);
}
function addGrupo(){
 const d=document.createElement("div");
 d.className="grupo-row";
 d.innerHTML=`
<select><option></option><option>Grupo 1</option><option>Grupo 2</option><option>Grupo 3</option><option>Grupo 4</option><option>Instala√ß√£o (toda parada)</option></select>
<input type="time" onchange="this.parentNode.querySelector('.t').value=calc(this.value,this.parentNode.querySelector('.f').value)">
<input type="time" class="f" onchange="this.parentNode.querySelector('.t').value=calc(this.parentNode.querySelector('input[type=time]').value,this.value)">
<input class="t" readonly>
<button class="btn-del" onclick="this.parentNode.remove()">X</button>`;
 $("lista_grupos").appendChild(d);
}
function listarGrupos(){
 return [...$("lista_grupos").children].map(g=>({
  grupo:g.children[0].value,
  inicio:g.children[1].value,
  fim:g.children[2].value,
  total:g.children[3].value
 }));
}

// ================== ASSINATURA ==================
const c=$("sign"),ctx=c.getContext("2d");
c.width=c.offsetWidth;c.height=180;
let desenhando=false;
c.onmousedown=e=>{desenhando=true;ctx.moveTo(e.offsetX,e.offsetY)};
c.onmousemove=e=>{if(desenhando){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke()}};
c.onmouseup=()=>desenhando=false;
function limparSign(){ctx.clearRect(0,0,c.width,c.height)}

// ================== FOTOS ==================
let fotos=[];
$("fotos").onchange=e=>{
 fotos=[];$("preview").innerHTML="";
 [...e.target.files].forEach(f=>{
  const r=new FileReader();
  r.onload=x=>{
   fotos.push(x.target.result);
   const i=document.createElement("img");i.src=x.target.result;
   $("preview").appendChild(i);
  };
  r.readAsDataURL(f);
 });
}

// ================== VALIDA√á√ÉO ==================
function validarFormulario(){
 if(!obrig($("instalacao").value)||!obrig($("municipio").value)||!obrig($("os").value))return false;
 if(!obrig($("nome1").value)||!obrig($("nome2").value))return false;
 if(!obrig($("ocorrencia").value)||!obrig($("resumo").value))return false;
 if(!obrig($("responsavel").value))return false;
 if(fotos.length===0)return false;
 if($("grupo_status").value==="")return false;
 if($("grupo_status").value==="Sim"){
  const gs=listarGrupos();
  if(gs.length===0||gs.some(g=>!obrig(g.grupo)||!obrig(g.total)))return false;
 }
 if($("eletrica_status").value===""||($("eletrica_status").value==="Sim"&&!obrig($("eletrica_dados").value)))return false;
 if($("hid_status").value===""||($("hid_status").value==="Sim"&&!obrig($("hid_dados").value)))return false;
 if($("mat_status").value===""||($("mat_status").value==="Sim"&&!obrig($("mat_dados").value)))return false;
 return true;
}

// ================== PDF (MANTIDO) ==================
async function gerarPDF(){
 if(!validarFormulario()){alert("Preencha todos os campos obrigat√≥rios.");return;}
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 doc.text("ORDEM DE MANUTEN√á√ÉO - RP ENGENHARIA",105,15,{align:"center"});
 doc.text("Respons√°vel: "+$("responsavel").value,10,25);
 doc.addImage(c.toDataURL(),"PNG",10,30,80,30);
 doc.save(`OM_${dataHoraArquivo()}_${$("os").value}.pdf`);
}

// ================== EXCEL (1 ABA) ==================
function gerarExcel(){
 if(!validarFormulario()){alert("Preencha todos os campos obrigat√≥rios.");return;}
 const grupos=$("grupo_status").value==="Sim"
 ?listarGrupos().map(g=>`${g.grupo} (${g.inicio}-${g.fim}=${g.total})`).join(" | ")
 :"";
 const linhas=[
 ["RP ENGENHARIA",""],
 ["ORDEM DE MANUTEN√á√ÉO",""],
 ["Desenvolvido por Lucas Moreira Rodrigues",""],
 ["",""],
 ["Campo","Valor"],
 ["Instala√ß√£o",$("instalacao").value],
 ["Munic√≠pio",$("municipio").value],
 ["OS SAP",$("os").value],
 ["Equipe",listarEquipe().join(" / ")],
 ["Grupos",$("grupo_status").value],
 ["Detalhe Grupos",grupos],
 ["Grandezas El√©tricas",$("eletrica_status").value],
 ["Medi√ß√µes El√©tricas",$("eletrica_dados").value],
 ["Inspe√ß√£o Hidr√°ulica",$("hid_status").value],
 ["Medi√ß√µes Hidr√°ulicas",$("hid_dados").value],
 ["Materiais",$("mat_status").value],
 ["Descri√ß√£o Materiais",$("mat_dados").value],
 ["Ocorr√™ncia",$("ocorrencia").value],
 ["Situa√ß√£o Encontrada",$("resumo").value],
 ["Servi√ßo Realizado",$("realizado").value],
 ["Respons√°vel",$("responsavel").value],
 ["Registro",new Date().toLocaleString("pt-BR")]
 ];
 const wb=XLSX.utils.book_new();
 const ws=XLSX.utils.aoa_to_sheet(linhas);
 ws["!merges"]=[{s:{r:0,c:0},e:{r:0,c:1}},{s:{r:1,c:0},e:{r:1,c:1}},{s:{r:2,c:0},e:{r:2,c:1}}];
 ws["!cols"]=[{wch:30},{wch:100}];
 XLSX.utils.book_append_sheet(wb,ws,"OM_Controle");
 XLSX.writeFile(wb,`OM_${dataHoraArquivo()}_${$("os").value}.xlsx`);
}

// ================== WHATSAPP ==================
function enviarWhats(){
 if(!validarFormulario()){alert("Preencha todos os campos obrigat√≥rios.");return;}
 gerarPDF();
 window.open("https://wa.me/55SEUNUMERO?text="+encodeURIComponent("OM "+$("os").value+" gerada com sucesso."));
}
</script>
</body>
</html>
